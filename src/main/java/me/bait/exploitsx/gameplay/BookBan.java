package me.bait.exploitsx.gameplay;

import me.bait.exploitsx.ExploitsX;
import me.bait.exploitsx.util.API;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.block.ShulkerBox;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerKickEvent;
import org.bukkit.event.player.PlayerQuitEvent;
import org.bukkit.inventory.meta.BlockStateMeta;

import java.util.HashMap;

public class BookBan implements Listener {

    private static final HashMap<Player, Integer> ef = new HashMap<>();
    private static final HashMap<Player, Integer> send = new HashMap<>();
    private int bookamt;

    public static void clear() {
        ef.clear();
        send.clear();
    }

    public void clearbooks(Player player) {
        if (ef.containsKey(player)) {
            if (ef.get(player) > 4) {
                for (org.bukkit.inventory.ItemStack item : player.getInventory().getContents()) {
                    if (item != null && item.getType() != null) {
                        if (item.getType().toString().contains("BOOK")) {
                            item.setAmount(0);
                        }
                        if (API.isShulkerBox(item.getType().toString())) {
                            BlockStateMeta meta = (BlockStateMeta) item.getItemMeta();
                            if (meta == null)
                                return;
                            ShulkerBox box = (ShulkerBox) meta.getBlockState();
                            if (box == null)
                                return;
                            bookamt = 0;
                            for (org.bukkit.inventory.ItemStack i : box.getInventory().getContents()) {
                                if (i != null && i.getType() != null) {
                                    if (i.getType().toString().contains("BOOK")) {
                                        item.setAmount(0);
                                    }
                                }
                            }
                        }
                    }
                }
                send.put(player, 1);
            }
        }
    }

    @EventHandler
    public void onjoin(PlayerJoinEvent e) {
        if (!ExploitsX.getPlugin().getConfig().getBoolean("enableantibookban"))
            return;
        bookamt = 0;
        final Player player = e.getPlayer();
        for (org.bukkit.inventory.ItemStack item : player.getInventory().getContents()) {
            if (item != null && item.getType() != null) {
                if (item.getType().toString().contains("BOOK")) {
                    bookamt = bookamt + 1;
                }
                if (bookamt > 8) {
                    if (ef.containsKey(player)) {
                        ef.put(player, (ef.get(player) + 1));
                    } else {
                        ef.put(player, 1);
                    }
                }
                if (API.isShulkerBox(item.getType().toString())) {
                    BlockStateMeta meta = (BlockStateMeta) item.getItemMeta();
                    if (meta == null)
                        return;
                    ShulkerBox box = (ShulkerBox) meta.getBlockState();
                    if (box == null)
                        return;
                    for (org.bukkit.inventory.ItemStack i : box.getInventory().getContents()) {
                        if (i != null) {
                            if (i.getType().toString().contains("BOOK")) {
                                bookamt = bookamt + 1;
                                if (bookamt > 8) {
                                    if (ef.containsKey(player)) {
                                        ef.put(player, (ef.get(player) + 1));
                                    } else {
                                        ef.put(player, 1);
                                    }
                                }
                            }
                        }
                    }
                }
            }

        }
        if (ef.containsKey(player)) {
            if (ef.get(player) > 4) {
                player.sendMessage(API.getPrefix() + ChatColor.DARK_RED
                        + "> DO NOT LEAVE WITHIN 3 SECONDS. If you do, books in your inventory will be cleared. Please limit the books in your inventory at once.");
                Bukkit.getScheduler().scheduleSyncDelayedTask(ExploitsX.getPlugin(), () -> ef.remove(player), 60L);
            }
        }
        if (send.containsKey(player)) {
            if (send.get(player) > 0) {
                player.sendMessage(API.getPrefix() + ChatColor.DARK_RED
                        + "> You left the server too quickly after joining, therefore your books were cleared in suspicion of a book ban.");
                send.remove(player);
            }
        }
    }

    @EventHandler
    public void onleave(PlayerQuitEvent e) {
        if (!ExploitsX.getPlugin().getConfig().getBoolean("enableantibookban"))
            return;
        Player player = e.getPlayer();
        clearbooks(player);
    }

    @EventHandler
    public void onleave2(PlayerKickEvent e) {
        if (!ExploitsX.getPlugin().getConfig().getBoolean("enableantibookban"))
            return;
        Player player = e.getPlayer();
        clearbooks(player);
    }
}