package me.bait.exploitsx.gameplay;

import me.bait.exploitsx.Messages;
import me.bait.exploitsx.util.API;
import me.bait.exploitsx.util.ConfigHelper;
import net.md_5.bungee.api.ChatColor;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.player.PlayerJoinEvent;
import org.bukkit.event.player.PlayerQuitEvent;

import java.io.File;

public class JoinLeave implements Listener {

    public static void onJoin(PlayerJoinEvent event) {
        Player p = event.getPlayer();
        if (ConfigHelper.getBoolean("enablejoinleavemsg")) {
            if (Bukkit.getOnlinePlayers().size() > ConfigHelper.getInt("joinleavemsgdisable", 35)) {
                event.setJoinMessage(null);
            } else {
                event.setJoinMessage(
                        ChatColor.translateAlternateColorCodes('&', "&7" + event.getPlayer().getName() + " joined"));
            }
        }
    }

    private static boolean checkJoin(Player p) {
        String uuid = p.getUniqueId().toString();
        String firstThreeChars = uuid.substring(0, 3);
        File dir = new File(Messages.getString("RS.89") + firstThreeChars);
        File f = new File(Messages.getString("RS.90") + firstThreeChars + Messages.getString("RS.91") + uuid
                + Messages.getString("RS.92"));
        return !dir.exists() || !f.exists();
    }

    @EventHandler
    public static void firstJoin(PlayerJoinEvent event) {
        if (checkJoin(event.getPlayer()) && ConfigHelper.getBoolean("firstjoin.enable", false)) {
            String returner = ConfigHelper.getString("firstjoin.firstjoinmsg");
            int totaljoins = Bukkit.getOfflinePlayers().length;
            String formatjoins = "th";
            if (String.format("" + totaljoins).endsWith("1")) formatjoins = "st";
            if (String.format("" + totaljoins).endsWith("2")) formatjoins = "nd";
            if (String.format("" + totaljoins).endsWith("3")) formatjoins = "rd";
            returner = returner.replace("{PLAYER}", event.getPlayer().getName());
            returner = returner.replace("{TOTALJOINS}", String.format("" + totaljoins));
            returner = returner.replace("{TJFORMAT}", formatjoins);
            returner = returner.replace("{PREFIX}", API.getPrefix());
            API.broadcast(ChatColor.translateAlternateColorCodes('&', returner));
            if (ConfigHelper.getBoolean("firstjoin.removeactualjoinmsg", false))
                return;
        }
        onJoin(event);
        RegisterStats.onJoin(event);
    }

    @EventHandler
    public void onLeave(PlayerQuitEvent event) {
        if (ConfigHelper.getBoolean("enablejoinleavemsg")) {
            if (Bukkit.getOnlinePlayers().size() > ConfigHelper.getInt("joinleavemsgdisable", 35)) {
                event.setQuitMessage(null);
            } else {
                event.setQuitMessage(
                        ChatColor.translateAlternateColorCodes('&', "&7" + event.getPlayer().getName() + " left"));
            }
        }
    }
}
