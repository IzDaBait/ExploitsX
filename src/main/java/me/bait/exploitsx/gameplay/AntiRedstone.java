package me.bait.exploitsx.gameplay;

import me.bait.exploitsx.ExploitsX;
import me.bait.exploitsx.util.API;
import me.bait.exploitsx.util.TPS;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockDispenseEvent;
import org.bukkit.event.block.BlockRedstoneEvent;

public class AntiRedstone implements Listener {

    private int rCount = 0;

    private boolean isRedstoneUI(Material m) {
        switch (m) {
            case WOOD_BUTTON:
            case STONE_BUTTON:
            case TRAPPED_CHEST:
                return true;
            default:
                return false;
        }
    }

    @EventHandler
    public void onDispense(BlockDispenseEvent event) {
        Location loc = event.getBlock().getLocation();
        int y = loc.getBlockY();
        if (y >= 254 || y <= 3) {
            event.setCancelled(true);
            API.alertMessage(API.getPrefix() + "&cDangerzone dispenser (Possible server crash event) at " + loc.toString());
        }
    }

    @EventHandler
    public void onRedstoneTick(BlockRedstoneEvent event) {
        Location loc = event.getBlock().getLocation();
        int blockY = loc.getBlockY();
        Block b = event.getBlock();
        if (blockY >= 254 || blockY <= 3) {
            event.setNewCurrent(0);
            b.setType(Material.AIR);
            API.alertMessage(API.getPrefix() + "&cDangerzone redstone at " + loc.toString());
        }
        if (!isRedstoneUI(b.getType()) && TPS.getTPS() <= ExploitsX.getPlugin().getConfig().getDouble("redcancel")) {
            event.setNewCurrent(0);
            if (TPS.getTPS() <= ExploitsX.getPlugin().getConfig().getDouble("redremove")) {
                b.breakNaturally();
            }
            if (rCount < 2) {
                rCount = rCount + 1;
                int blockX = loc.getBlockX();
                int blockZ = loc.getBlockZ();
                API.alertMessage(ChatColor.translateAlternateColorCodes('&',
                        "&6Redstone lag detected at &cX: " + blockX + ", Y: " + blockY + ", Z:" + blockZ));
                Bukkit.getScheduler().scheduleSyncDelayedTask(ExploitsX.getPlugin(), () -> rCount = 0, 80L);
            }
        }
    }
}
