package me.bait.exploitsx.gameplay;

import me.bait.exploitsx.ExploitsX;
import me.bait.exploitsx.util.API;
import me.bait.exploitsx.util.TPS;
import org.bukkit.Bukkit;
import org.bukkit.ChatColor;
import org.bukkit.Material;
import org.bukkit.event.EventHandler;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockDispenseEvent;
import org.bukkit.event.block.BlockRedstoneEvent;

public class AntiRedstone implements Listener {

    private int rCount = 0;

    private boolean isRedstoneUI(Material m) {
        switch (m) {
            case WOOD_BUTTON:
            case STONE_BUTTON:
            case TRAPPED_CHEST:
                return true;
            default:
                return false;
        }
    }

    @EventHandler
    public void onDispense(BlockDispenseEvent event) {
        if (event.getBlock().getLocation().getBlockY() >= 254 || event.getBlock().getLocation().getBlockY() <= 3) {
            event.setCancelled(true);
            API.alertMessage(API.getPrefix() + "&cDangerzone dispenser at " + event.getBlock().getLocation().toString());
        }
    }

    @EventHandler
    public void onRedstoneTick(BlockRedstoneEvent event) {
        if (event.getBlock().getLocation().getBlockY() >= 254 || event.getBlock().getLocation().getBlockY() <= 3) {
            event.setNewCurrent(0);
            event.getBlock().setType(Material.AIR);
            API.alertMessage(API.getPrefix() + "&cDangerzone redstone at " + event.getBlock().getLocation().toString());
        }
        if (!isRedstoneUI(event.getBlock().getType()) && TPS.getTPS() <= ExploitsX.getPlugin().getConfig().getDouble("redcancel")) {
            event.setNewCurrent(0);

            if (TPS.getTPS() <= ExploitsX.getPlugin().getConfig().getDouble("redremove")) {
                event.getBlock().breakNaturally();
            }

            if (rCount < 2) {
                rCount = rCount + 1;

                int blockX = event.getBlock().getLocation().getBlockX();
                int blockY = event.getBlock().getLocation().getBlockY();
                int blockZ = event.getBlock().getLocation().getBlockZ();
                API.println(ChatColor.translateAlternateColorCodes('&',
                        "&6Likely lag Machine at &cX: " + blockX + ", Y: " + blockY + ", Z:" + blockZ));
                Bukkit.getScheduler().scheduleSyncDelayedTask(ExploitsX.getPlugin(), () -> rCount = 0, 80L);
            }
        }
    }
}
